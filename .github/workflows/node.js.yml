name: Node.js API CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_ENV: production
  API_VERSION: v1
  MONGO_URI: ${{ secrets.MONGO_URI }}
  MONGO_URI_TEST: ${{ secrets.MONGO_URI_TEST }}
  PORT: 5000
  ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
  ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
  ACCESS_TOKEN_EXPIRY_TIME: 1h
  REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET }}
  REFRESH_TOKEN_EXPIRY_TIME: 7d
  REQUIRE_ACTIVATION: true
  RATE_LIMIT_PER_HOUR: 1000

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
          path: 'backend-app/'

      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'
      - name: Set up environment variables
        run: |
          touch backend-app/.env
          echo "NODE_ENV=${{ env.NODE_ENV }}" > backend-app/.env
          echo "API_VERSION=${{ env.API_VERSION }}" >> backend-app/.env
          echo "MONGO_URI=${{ env.MONGO_URI }}" >> backend-app/.env
          echo "MONGO_URI_TEST=${{ env.MONGO_URI_TEST }}" >> backend-app/.env
          echo "PORT=${{ env.PORT }}" >> backend-app/.env
          echo "ADMIN_EMAIL=${{ env.ADMIN_EMAIL }}" >> backend-app/.env
          echo "ADMIN_PASSWORD=${{ env.ADMIN_PASSWORD }}" >> backend-app/.env
          echo "ACCESS_TOKEN_SECRET=${{ env.ACCESS_TOKEN_SECRET }}" >> backend-app/.env
          echo "ACCESS_TOKEN_EXPIRY_TIME=${{ env.ACCESS_TOKEN_EXPIRY_TIME }}" >> backend-app/.env
          echo "REFRESH_TOKEN_SECRET=${{ env.REFRESH_TOKEN_SECRET }}" >> backend-app/.env
          echo "REFRESH_TOKEN_EXPIRY_TIME=${{ env.REFRESH_TOKEN_EXPIRY_TIME }}" >> backend-app/.env
          echo "REQUIRE_ACTIVATION=${{ env.REQUIRE_ACTIVATION }}" >> backend-app/.env
          echo "RATE_LIMIT_PER_HOUR=${{ env.RATE_LIMIT_PER_HOUR }}" >> backend-app/.env
      - name: Install dependencies
        run: |
          cd backend-app/
          npm install
        working-directory: backend-app/

      - name: Build
        run: |
          cd backend-app/
          npm run build
        working-directory: backend-app/

      - name: Run tests
        run: |
          cd backend-app/
          npm run test:build
        working-directory: backend-app/
